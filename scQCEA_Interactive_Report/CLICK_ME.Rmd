
```{r, echo = FALSE}
setwd(dirname(rstudioapi::getActiveDocumentContext()$path))

library(data.table)

PInf = fread('Inputs_Interactive_Report/PInf.txt', stringsAsFactors = F, header = F)

ProjectName <- gsub('.*=','',PInf$V1[1])
ProjectNameFTP_Path <- gsub('.*=','',PInf$V2[1])
ProjectNameFTP_password <- gsub('.*=','',PInf$V3[1])
# CustomerName <- 'Ian Reekie'
PM <- gsub(' \t','',PInf$V2[2])
premade = TRUE
# setwd("/Users/isar/Desktop/Notes_USED/Scripts_OGC_USED/StepC_QC_report_USED")
# subtitle: "Client Name: `r CustomerName`"
```

<!-- Insert a logo in upper right corner of R markdown html document -->
  
```{r, echo=FALSE}
htmltools::img(src = knitr::image_uri("OGC_logo.jpeg"), 
               alt = 'logo', 
               style = 'position:absolute; top:0; right:0; padding:10px; out.width = "5px";')
```

---
title: "Project `r ProjectName` Workflow and Results"
date: "Report compiled on `r format(Sys.time(), '%d %B, %Y')`"
author: "Project Manager: `r PM`"

output:
  html_document:
    self_contained = TRUE
  css: "style.css"
code_download: true
---

```{css, echo=FALSE}
p {
  font-size: 13px;
}

h1.title {
  font-size: 38px;
  color: DarkRed;
  text-align: center;
}
h3.subtitle {
  font-size: 17px;
  color: DarkBlue;
  text-align: center;
}
h4.author {
  font-size: 16px;
  color: DarkGreen;
  text-align: center;
}
h4.date { /* Header 4 - and the author and data headers use this too  */
    font-size: 16px;
  font-family: "Times New Roman", Times, serif;
  color: bg-palevioletred1;
  text-align: center;
}

```

```{r setup1, include=FALSE, echo=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
library(dplyr)
library(kableExtra)
library(DT)
library(downloadthis)
library(ggplot2)
library(data.table)

library(kableExtra)
options(knitr.table.format = "latex")
```

### Workflows

#### Workflow of scRNA sequencing
scRNAseq transcriptome processing was performed using the Chromium 10x system involving GEM generation, post GEM-generation clean-up, cDNA amplification and DNA quantification. The library was sequencing using the Illumina NovaSeq platform. 

#### Experimental Workflow
```{r, echo=FALSE}

Experimental_Data = fread('Inputs_Interactive_Report/Experimental_Data.txt', stringsAsFactors = F, header = T)

# Chemistry=Experimental_Data$Chemistry
Av_cell=Experimental_Data$Av_cell
Av_Viability=Experimental_Data$Av_Viability
vCell_Suspension=Experimental_Data$vCell_Suspension
Capture_efficiency=Experimental_Data$Capture_efficiency
Av_Num_Cells_to_Load=Experimental_Data$Av_Num_Cells_to_Load
```

```{r readMetaData, echo=FALSE}
metadata = fread('Inputs_Interactive_Report/samples.metadata', stringsAsFactors = F, header = T)

Chemistry=unique(metadata$`Library Type`)

metadata$`Library Type`[grep('10X SC RNA 5pr', metadata$`Library Type`)] = '10X SC RNA GEX'
metadata$`Library Type`[grep('10X SC RNA 3pr', metadata$`Library Type`)] = '10X SC RNA GEX'
metadata$`Library Type`[grep('10X SC mxRNA', metadata$`Library Type`)] = '10X SC RNA GEX'

metadata$`Library Type`[grep('10X SC VDJ BCR', metadata$`Library Type`)] = '10X SC VDJ'
metadata$`Library Type`[grep('10X SC VDJ TCR', metadata$`Library Type`)] = '10X SC VDJ'

metadata$`Library Type`[grep('10X SC RNA CITE-TSC', metadata$`Library Type`)] = '10X SC RNA CITE'
metadata$`Library Type`[grep('10X SC RNA CITE-TSB', metadata$`Library Type`)] = '10X SC RNA CITE'

metadata$`Library Type`[grep('10X SC ATAC', metadata$`Library Type`)] = '10X SC ATAC'

Applications = c('10X SC RNA CITE',
'10X SC RNA GEX',  
'10X SC VDJ',
'10X SC RNA HTO-CMO',
'10X SC mxATAC',
'10X SC ATAC')

Applications_in_metatData = which(Applications %in% unique(metadata$`Library Type`))

ApplicationsSelected <- logical(length(Applications)) 
names(ApplicationsSelected) = c('CITE', 'GEX', 'VDJ', 'CMO', 'mxATAC', 'ATAC')
ApplicationsSelected[Applications_in_metatData] = TRUE;

for(i in 1:length(ApplicationsSelected))
{
  assign(names(ApplicationsSelected[i]), as.logical(ApplicationsSelected[i]))
}

#----- select grouped application

Applications_in_metatData_raw = unique(metadata$`Library Type`)

# NOTE: REVISE THE METADATA FILE ACCORDINGLY
Name_index = data.frame(Applications_name = c('10X SC RNA CITE',
'10X SC RNA GEX',  
'10X SC VDJ',
'10X SC RNA HTO-CMO',
'10X SC mxATAC',
'10X SC ATAC'),
Applications_index = c('CITE', 'GEX', 'VDJ', 'CMO', 'mxATAC', 'ATAC'), stringsAsFactors = F)

#-- function for Assign multiple variables
assignVec <- Vectorize("assign", c("x", "value"))
`%<<-%` <- function(x, value) invisible(assignVec(x, value, envir = .GlobalEnv))

#-- assign all applications as without grouping
paste0(Name_index[,'Applications_index'],'grouped') %<<-% replicate(length(Name_index[,'Applications_index']),FALSE)

#-- assign application with grouping
for(i in 1:length(Applications_in_metatData_raw))
  {
    if(any(duplicated(metadata[grep(Applications_in_metatData_raw[i], metadata$`Library Type`),'LIMS ID']))){
      assign(paste0(Name_index[which(Name_index$Applications_name == Applications_in_metatData_raw[i]),'Applications_index'],'grouped'), TRUE)
  }
}

application=gsub(" ", "', and '",capture.output(cat(names(ApplicationsSelected[Applications_in_metatData]))))

```

Chromium Single Cell Reagent Kits solution (`r Chemistry` Chemistry) was used to deliver a scalable microfluidic platform for digital `r application` by profiling 500-10,000 individual cells per sample. A pool of ~3,500,000 10x Barcodes were sampled separately to index each cell’s transcriptome. It is done by partitioning thousands of cells into nanoliter-scale Gel Beads-in-emulsion (GEMs), where all generated cDNA share a common 10x Barcode. Libraries were generated and sequenced from the cDNAs and 10x Barcodes were used to associate individual reads back to the individual partitions. 

<!-- Average of sample concentration was `r Av_cell` $\times 10^5$ cells/ml, average viability `r Av_Viability`, and average cell suspension `r vCell_Suspension`. The average cell-capture efficiency of library pooling was `r Capture_efficiency`, relative to `r Av_Num_Cells_to_Load` average number of cells loaded on the instrument. -->

#### Data processing Workflow
Analysis pipeline is applied to process Chromium single-cell data to align reads, generate feature-barcode matrices, perform clustering and other secondary analysis. Illumina's bcl2fastq and cellranger mkfastq demultiplexes are used to convert the raw base call (BCL) files generated by Illumina sequencers into FASTQ files.

```{r , child='GEX.Rmd', eval=GEX, echo=FALSE}

```

```{r , child='GEXgrouped.Rmd', eval=GEXgrouped, echo=FALSE}

```
 
```{r , child='VDJ.Rmd', eval=VDJ, echo=FALSE}

```

```{r , child='VDJgrouped.Rmd', eval=VDJgrouped, echo=FALSE}

```

```{r , child='CMO.Rmd', eval=CMO, echo=FALSE}

```

```{r , child='CMOgrouped.Rmd', eval=CMOgrouped, echo=FALSE}

```

```{r , child='mxATAC.Rmd', eval=mxATAC, echo=FALSE}

```

```{r , child='mxATACgrouped.Rmd', eval=mxATACgrouped, echo=FALSE}

```

```{r , child='ATAC.Rmd', eval=ATAC, echo=FALSE}

```

```{r , child='ATACgrouped.Rmd', eval=ATACgrouped, echo=FALSE}

```

```{r , child='CITE.Rmd', eval=CITE, echo=FALSE}

```

```{r , child='CITEgrouped.Rmd', eval=CITEgrouped, echo=FALSE}

```

### Samples information and QC metrics {.tabset}

#### Meta data

Metadata is created at multiple points throughout the pipeline. This document includes information about the size of the batch load and resources that can be used to conduct QC.

```{r, class.output="scroll-10", echo=FALSE}  

metadata = fread('Inputs_Interactive_Report/samples.metadata', stringsAsFactors = F, header = T)

colnames(metadata) = c('ProjectNumber', 'LIMSID', 'Sample', 'Name', 'IndexLibrary', 'TypeGenome', 'FlowcellID', 'LaneNumber', 'SequencingID')

metadata = as.data.frame(metadata)
metadata = metadata[order(metadata$Sample),]
#retrieve row numbers after sorting
row.names(metadata) = 1:dim(metadata)[1]

datatable(metadata[,-which(colnames(metadata) %in% c('ProjectNumber', 'Name'))], extensions = c('Select', 'Scroller', 'KeyTable', 'FixedHeader', 'FixedColumns', 'ColReorder','Buttons'), options = list(
    buttons = c('copy', 'csv', 'excel', 'pdf', 'print', 'selectAll', 'selectNone', 'selectRows', 'selectColumns', 'selectCells'),
    select = list(style = 'os', items = 'row'),
    dom = 'Blfrtip',
    rowId = 0,
    colReorder = TRUE,
    scrollX = TRUE,
    fixedColumns = TRUE,
    keys = TRUE,
    deferRender = TRUE,
    scrollY = 200,
    scroller = TRUE,
    pageLength = 5, autoWidth = TRUE, fixedHeader = F)) %>%
  formatStyle(columns = colnames(.$x$data), `font-size` = '12px')
```
 
#### QC table(s)

Quality control for 10x Genomics single-cell RNA-seq data, Unique gene counts for cells, separated by samples.

`r if(GEX){text_spec("Gene Expression profile", background = "#D05A6E", color = "white", bold = T, font_size = 16)}`

```{r , eval=GEX, echo=FALSE}

filenames =  list.files('Inputs_Interactive_Report/10X-gex', pattern = 'summary.csv', recursive = T)

filenames = paste0('Inputs_Interactive_Report/10X-gex/', filenames)
require(data.table) ## 1.9.2 or 1.9.3
merged = rbindlist(lapply(filenames, fread))

names = gsub('Inputs_Interactive_Report/10X-gex/|/outs/metrics_summary.csv|/outs/summary.csv','',filenames)
merged = as.data.frame(merged)

QC = cbind(SequencingID = names, merged)
# QC = apply(QC, 2, function(y) (gsub(",", "", y)))

library(dplyr)
QC = right_join(metadata[, c('LIMSID', 'Sample', 'SequencingID')], QC, by = 'SequencingID')

datatable(QC, extensions = c('Select', 'Scroller', 'KeyTable', 'FixedHeader', 'FixedColumns', 'ColReorder','Buttons'), options = list(
    buttons = c('copy', 'csv', 'excel', 'pdf', 'print', 'selectAll', 'selectNone', 'selectRows', 'selectColumns', 'selectCells'),
    select = list(style = 'os', items = 'row'),
    dom = 'Blfrtip',
    rowId = 0,
    colReorder = TRUE,
    scrollX = TRUE,
    fixedColumns = TRUE,
    keys = TRUE,
    deferRender = TRUE,
    scrollY = 200,
    scroller = TRUE,
    pageLength = 5, autoWidth = TRUE, fixedHeader = F)) %>%
  formatStyle(columns = colnames(.$x$data), `font-size` = '12px')
```

`r if(GEXgrouped){text_spec("Gene Expression profiles - grouped", background = "#D05A6E", color = "white", bold = T, font_size = 16)}`

```{r , eval=GEXgrouped, echo=FALSE}

filenames =  list.files('Inputs_Interactive_Report/10X-gex-grouped', pattern = 'summary.csv', recursive = T)

filenames = paste0('Inputs_Interactive_Report/10X-gex-grouped/', filenames)
require(data.table) ## 1.9.2 or 1.9.3
merged = rbindlist(lapply(filenames, fread))

names = gsub('Inputs_Interactive_Report/10X-gex-grouped/|/outs/metrics_summary.csv|/outs/summary.csv','',filenames)
merged = as.data.frame(merged)

QC = cbind(LIMSID = names, merged)
# QC = apply(QC, 2, function(y) (gsub(",", "", y)))

library(dplyr)
QC = right_join(metadata[, c('LIMSID', 'Sample', 'SequencingID')], QC, by = 'LIMSID')

library(dplyr)
QC = QC %>% group_by(LIMSID) %>% 
       mutate(SequencingID = paste(SequencingID, collapse=","))

QC = QC[!duplicated(QC$LIMSID),]

datatable(QC, extensions = c('Select', 'Scroller', 'KeyTable', 'FixedHeader', 'FixedColumns', 'ColReorder','Buttons'), options = list(
    buttons = c('copy', 'csv', 'excel', 'pdf', 'print', 'selectAll', 'selectNone', 'selectRows', 'selectColumns', 'selectCells'),
    select = list(style = 'os', items = 'row'),
    dom = 'Blfrtip',
    rowId = 0,
    colReorder = TRUE,
    scrollX = TRUE,
    fixedColumns = TRUE,
    keys = TRUE,
    deferRender = TRUE,
    scrollY = 200,
    scroller = TRUE,
    pageLength = 5, autoWidth = TRUE, fixedHeader = F)) %>%
  formatStyle(columns = colnames(.$x$data), `font-size` = '12px')
```


`r if(CITE){text_spec("Gene Expression with Feature Barcoding technology", background = "#D05A6E", color = "white", bold = T, font_size = 16)}`

```{r , eval=CITE, echo=FALSE}

filenames =  list.files('Inputs_Interactive_Report/10X-feat', pattern = 'summary.csv', recursive = T)

filenames = paste0('Inputs_Interactive_Report/10X-feat/', filenames)
require(data.table) ## 1.9.2 or 1.9.3
merged = rbindlist(lapply(filenames, fread))

names = gsub('Inputs_Interactive_Report/10X-feat/|/outs/metrics_summary.csv|/outs/summary.csv','',filenames)
merged = as.data.frame(merged)

QC = cbind(SequencingID = names, merged)

library(dplyr)
QC = right_join(metadata[, c('LIMSID', 'Sample', 'SequencingID')], QC, by = 'SequencingID')

datatable(QC, extensions = c('Select', 'Scroller', 'KeyTable', 'FixedHeader', 'FixedColumns', 'ColReorder','Buttons'), options = list(
    buttons = c('copy', 'csv', 'excel', 'pdf', 'print', 'selectAll', 'selectNone', 'selectRows', 'selectColumns', 'selectCells'),
    select = list(style = 'os', items = 'row'),
    dom = 'Blfrtip',
    rowId = 0,
    colReorder = TRUE,
    scrollX = TRUE,
    fixedColumns = TRUE,
    keys = TRUE,
    deferRender = TRUE,
    scrollY = 200,
    scroller = TRUE,
    pageLength = 5, autoWidth = TRUE, fixedHeader = F)) %>%
  formatStyle(columns = colnames(.$x$data), `font-size` = '12px')
```

`r if(CITEgrouped){text_spec("Gene Expression with Feature Barcoding technology - grouped", background = "#D05A6E", color = "white", bold = T, font_size = 16)}`

```{r , eval=CITEgrouped, echo=FALSE}

filenames =  list.files('Inputs_Interactive_Report/10X-feat-grouped', pattern = 'summary.csv', recursive = T)

filenames = paste0('Inputs_Interactive_Report/10X-feat-grouped/', filenames)
require(data.table) ## 1.9.2 or 1.9.3
merged = rbindlist(lapply(filenames, fread))

names = gsub('Inputs_Interactive_Report/10X-feat-grouped/|/outs/metrics_summary.csv|/outs/summary.csv','',filenames)
merged = as.data.frame(merged)

QC = cbind(LIMSID = names, merged)
# QC = apply(QC, 2, function(y) (gsub(",", "", y)))

library(dplyr)
QC = right_join(metadata[, c('LIMSID', 'Sample', 'SequencingID')], QC, by = 'LIMSID')

library(dplyr)
QC = QC %>% group_by(LIMSID) %>% 
       mutate(SequencingID = paste(SequencingID, collapse=","))

QC = QC[!duplicated(QC$LIMSID),]

datatable(QC, extensions = c('Select', 'Scroller', 'KeyTable', 'FixedHeader', 'FixedColumns', 'ColReorder','Buttons'), options = list(
    buttons = c('copy', 'csv', 'excel', 'pdf', 'print', 'selectAll', 'selectNone', 'selectRows', 'selectColumns', 'selectCells'),
    select = list(style = 'os', items = 'row'),
    dom = 'Blfrtip',
    rowId = 0,
    colReorder = TRUE,
    scrollX = TRUE,
    fixedColumns = TRUE,
    keys = TRUE,
    deferRender = TRUE,
    scrollY = 200,
    scroller = TRUE,
    pageLength = 5, autoWidth = TRUE, fixedHeader = F)) %>%
  formatStyle(columns = colnames(.$x$data), `font-size` = '12px')
```

`r if(CMO){text_spec("Gene Expression with Cell Multiplexing technology", background = "#D05A6E", color = "white", bold = T, font_size = 16)}`

```{r , eval=CMO, echo=FALSE}

filenames =  list.files('Inputs_Interactive_Report/10X-cmo', pattern = 'summary.csv', recursive = T)

filenames = paste0('Inputs_Interactive_Report/10X-cmo/', filenames)
require(data.table) ## 1.9.2 or 1.9.3
merged = rbindlist(lapply(filenames, fread))

names = gsub('Inputs_Interactive_Report/10X-cmo/|/outs/metrics_summary.csv|/outs/summary.csv','',filenames)
merged = as.data.frame(merged)

QC = cbind(SequencingID = names, merged)

library(dplyr)
QC = right_join(metadata[, c('LIMSID', 'Sample', 'SequencingID')], QC, by = 'SequencingID')

datatable(QC, extensions = c('Select', 'Scroller', 'KeyTable', 'FixedHeader', 'FixedColumns', 'ColReorder','Buttons'), options = list(
    buttons = c('copy', 'csv', 'excel', 'pdf', 'print', 'selectAll', 'selectNone', 'selectRows', 'selectColumns', 'selectCells'),
    select = list(style = 'os', items = 'row'),
    dom = 'Blfrtip',
    rowId = 0,
    colReorder = TRUE,
    scrollX = TRUE,
    fixedColumns = TRUE,
    keys = TRUE,
    deferRender = TRUE,
    scrollY = 200,
    scroller = TRUE,
    pageLength = 5, autoWidth = TRUE, fixedHeader = F)) %>%
  formatStyle(columns = colnames(.$x$data), `font-size` = '12px')
```

`r if(CMOgrouped){text_spec("Gene Expression with Cell Multiplexing technology - grouped", background = "#D05A6E", color = "white", bold = T, font_size = 16)}`

```{r , eval=CMOgrouped, echo=FALSE}

filenames =  list.files('Inputs_Interactive_Report/10X-cmo-grouped', pattern = 'summary.csv', recursive = T)

filenames = paste0('Inputs_Interactive_Report/10X-cmo-grouped/', filenames)
require(data.table) ## 1.9.2 or 1.9.3
merged = rbindlist(lapply(filenames, fread))

names = gsub('Inputs_Interactive_Report/10X-cmo-grouped/|/outs/metrics_summary.csv|/outs/summary.csv','',filenames)
merged = as.data.frame(merged)

QC = cbind(LIMSID = names, merged)
# QC = apply(QC, 2, function(y) (gsub(",", "", y)))

library(dplyr)
QC = right_join(metadata[, c('LIMSID', 'Sample', 'SequencingID')], QC, by = 'LIMSID')

library(dplyr)
QC = QC %>% group_by(LIMSID) %>% 
       mutate(SequencingID = paste(SequencingID, collapse=","))

QC = QC[!duplicated(QC$LIMSID),]

datatable(QC, extensions = c('Select', 'Scroller', 'KeyTable', 'FixedHeader', 'FixedColumns', 'ColReorder','Buttons'), options = list(
    buttons = c('copy', 'csv', 'excel', 'pdf', 'print', 'selectAll', 'selectNone', 'selectRows', 'selectColumns', 'selectCells'),
    select = list(style = 'os', items = 'row'),
    dom = 'Blfrtip',
    rowId = 0,
    colReorder = TRUE,
    scrollX = TRUE,
    fixedColumns = TRUE,
    keys = TRUE,
    deferRender = TRUE,
    scrollY = 200,
    scroller = TRUE,
    pageLength = 5, autoWidth = TRUE, fixedHeader = F)) %>%
  formatStyle(columns = colnames(.$x$data), `font-size` = '12px')
```

`r if(VDJ){text_spec("Single Cell Immune Profiling", background = "#D05A6E", color = "white", bold = T, font_size = 16)}`
```{r , eval=VDJ, echo=FALSE}

filenames =  list.files('Inputs_Interactive_Report/10X-vdj', pattern = 'summary.csv', recursive = T)

filenames = paste0('Inputs_Interactive_Report/10X-vdj/', filenames)
require(data.table) ## 1.9.2 or 1.9.3

t=0
for(NAMES in filenames)
{
  temp = fread(NAMES, stringsAsFactors = F, header = T)
  
  if(t==0){merged = temp}else{merged = rbind(merged, temp, fill = TRUE)}
  t=t+1
}

names = gsub('Inputs_Interactive_Report/10X-vdj/|/outs/metrics_summary.csv|/outs/summary.csv','',filenames)
merged = as.data.frame(merged)

QC = cbind(SequencingID = names, merged)

library(dplyr)
QC = right_join(metadata[, c('LIMSID', 'Sample', 'SequencingID')], QC, by = 'SequencingID')

datatable(QC, extensions = c('Select', 'Scroller', 'KeyTable', 'FixedHeader', 'FixedColumns', 'ColReorder','Buttons'), options = list(
    buttons = c('copy', 'csv', 'excel', 'pdf', 'print', 'selectAll', 'selectNone', 'selectRows', 'selectColumns', 'selectCells'),
    select = list(style = 'os', items = 'row'),
    dom = 'Blfrtip',
    rowId = 0,
    colReorder = TRUE,
    scrollX = TRUE,
    fixedColumns = TRUE,
    keys = TRUE,
    deferRender = TRUE,
    scrollY = 200,
    scroller = TRUE,
    pageLength = 5, autoWidth = TRUE, fixedHeader = F)) %>%
  formatStyle(columns = colnames(.$x$data), `font-size` = '12px')
```

`r if(VDJgrouped){text_spec("Single Cell Immune Profiling - grouped", background = "#D05A6E", color = "white", bold = T, font_size = 16)}`
```{r , eval=VDJgrouped, echo=FALSE}

filenames =  list.files('Inputs_Interactive_Report/10X-vdj-grouped', pattern = 'summary.csv', recursive = T)

filenames = paste0('Inputs_Interactive_Report/10X-vdj-grouped/', filenames)
require(data.table) ## 1.9.2 or 1.9.3
t=0
for(NAMES in filenames)
{
  temp = fread(NAMES, stringsAsFactors = F, header = T)
  
  if(t==0){merged = temp}else{merged = rbind(merged, temp, fill = TRUE)}
  t=t+1
}
names = gsub('Inputs_Interactive_Report/10X-vdj-grouped/|/outs/metrics_summary.csv|/outs/summary.csv','',filenames)
merged = as.data.frame(merged)

QC = cbind(LIMSID = names, merged)
# QC = apply(QC, 2, function(y) (gsub(",", "", y)))

library(dplyr)
QC = right_join(metadata[, c('LIMSID', 'Sample', 'SequencingID')], QC, by = 'LIMSID')

library(dplyr)
QC = QC %>% group_by(LIMSID) %>% 
       mutate(SequencingID = paste(SequencingID, collapse=","))

QC = QC[!duplicated(QC$LIMSID),]

datatable(QC, extensions = c('Select', 'Scroller', 'KeyTable', 'FixedHeader', 'FixedColumns', 'ColReorder','Buttons'), options = list(
    buttons = c('copy', 'csv', 'excel', 'pdf', 'print', 'selectAll', 'selectNone', 'selectRows', 'selectColumns', 'selectCells'),
    select = list(style = 'os', items = 'row'),
    dom = 'Blfrtip',
    rowId = 0,
    colReorder = TRUE,
    scrollX = TRUE,
    fixedColumns = TRUE,
    keys = TRUE,
    deferRender = TRUE,
    scrollY = 200,
    scroller = TRUE,
    pageLength = 5, autoWidth = TRUE, fixedHeader = F)) %>%
  formatStyle(columns = colnames(.$x$data), `font-size` = '12px')
```

`r if(mxATAC){text_spec("Multiome ATAC + Gene Expression", background = "#D05A6E", color = "white", bold = T, font_size = 16)}`
```{r , eval=mxATAC, echo=FALSE}

filenames =  list.files('Inputs_Interactive_Report/10X-arc', pattern = 'summary.csv', recursive = T)

filenames = paste0('Inputs_Interactive_Report/10X-arc/', filenames)
require(data.table) ## 1.9.2 or 1.9.3
merged = rbindlist(lapply(filenames, fread))

names = gsub('Inputs_Interactive_Report/10X-arc/|/outs/metrics_summary.csv|/outs/summary.csv','',filenames)
merged = as.data.frame(merged)

QC = cbind(SequencingID = names, merged)

library(dplyr)
QC = right_join(metadata[, c('LIMSID', 'Sample', 'SequencingID')], QC, by = 'SequencingID')

datatable(QC, extensions = c('Select', 'Scroller', 'KeyTable', 'FixedHeader', 'FixedColumns', 'ColReorder','Buttons'), options = list(
    buttons = c('copy', 'csv', 'excel', 'pdf', 'print', 'selectAll', 'selectNone', 'selectRows', 'selectColumns', 'selectCells'),
    select = list(style = 'os', items = 'row'),
    dom = 'Blfrtip',
    rowId = 0,
    colReorder = TRUE,
    scrollX = TRUE,
    fixedColumns = TRUE,
    keys = TRUE,
    deferRender = TRUE,
    scrollY = 200,
    scroller = TRUE,
    pageLength = 5, autoWidth = TRUE, fixedHeader = F)) %>%
  formatStyle(columns = colnames(.$x$data), `font-size` = '12px')
```

`r if(ATAC){text_spec("Chromium Single Cell ATAC library", background = "#D05A6E", color = "white", bold = T, font_size = 16)}`
```{r , eval=ATAC, echo=FALSE}

filenames =  list.files('Inputs_Interactive_Report/10X-atac', pattern = 'summary.csv', recursive = T)

filenames = paste0('Inputs_Interactive_Report/10X-atac/', filenames)
require(data.table) ## 1.9.2 or 1.9.3
merged = rbindlist(lapply(filenames, fread))

names = gsub('Inputs_Interactive_Report/10X-atac/|/outs/metrics_summary.csv|/outs/summary.csv','',filenames)
merged = as.data.frame(merged)

QC = cbind(SequencingID = names, merged)

library(dplyr)
QC = right_join(metadata[, c('LIMSID', 'Sample', 'SequencingID')], QC, by = 'SequencingID')

datatable(QC, extensions = c('Select', 'Scroller', 'KeyTable', 'FixedHeader', 'FixedColumns', 'ColReorder','Buttons'), options = list(
    buttons = c('copy', 'csv', 'excel', 'pdf', 'print', 'selectAll', 'selectNone', 'selectRows', 'selectColumns', 'selectCells'),
    select = list(style = 'os', items = 'row'),
    dom = 'Blfrtip',
    rowId = 0,
    colReorder = TRUE,
    scrollX = TRUE,
    fixedColumns = TRUE,
    keys = TRUE,
    deferRender = TRUE,
    scrollY = 200,
    scroller = TRUE,
    pageLength = 5, autoWidth = TRUE, fixedHeader = F)) %>%
  formatStyle(columns = colnames(.$x$data), `font-size` = '12px')
```

`r if(ATACgrouped){text_spec("Chromium Single Cell ATAC library - grouped", background = "#D05A6E", color = "white", bold = T, font_size = 16)}`
```{r , eval=ATACgrouped, echo=FALSE}

filenames =  list.files('Inputs_Interactive_Report/10X-atac-grouped', pattern = 'summary.csv', recursive = T)

filenames = paste0('Inputs_Interactive_Report/10X-atac-grouped/', filenames)
require(data.table) ## 1.9.2 or 1.9.3
merged = rbindlist(lapply(filenames, fread))

names = gsub('Inputs_Interactive_Report/10X-atac-grouped/|/outs/metrics_summary.csv|/outs/summary.csv','',filenames)
merged = as.data.frame(merged)

QC = cbind(LIMSID = names, merged)
# QC = apply(QC, 2, function(y) (gsub(",", "", y)))

library(dplyr)
QC = right_join(metadata[, c('LIMSID', 'Sample', 'SequencingID')], QC, by = 'LIMSID')

library(dplyr)
QC = QC %>% group_by(LIMSID) %>% 
       mutate(SequencingID = paste(SequencingID, collapse=","))

QC = QC[!duplicated(QC$LIMSID),]

datatable(QC, extensions = c('Select', 'Scroller', 'KeyTable', 'FixedHeader', 'FixedColumns', 'ColReorder','Buttons'), options = list(
    buttons = c('copy', 'csv', 'excel', 'pdf', 'print', 'selectAll', 'selectNone', 'selectRows', 'selectColumns', 'selectCells'),
    select = list(style = 'os', items = 'row'),
    dom = 'Blfrtip',
    rowId = 0,
    colReorder = TRUE,
    scrollX = TRUE,
    fixedColumns = TRUE,
    keys = TRUE,
    deferRender = TRUE,
    scrollY = 200,
    scroller = TRUE,
    pageLength = 5, autoWidth = TRUE, fixedHeader = F)) %>%
  formatStyle(columns = colnames(.$x$data), `font-size` = '12px')
```

### Data Analysis and Quality Control {.tabset}

We applied the area under the curve and bimodal distribution to separate the distributions and evaluate the strength of enrichment of each reference cell with genes in an indicated cell. These results can be used for objective selection of insightful optimal cluster numbers and discriminate between true variation and background noise. 

`r if(GEX){"#### UMAP Plot"}`
`r if(GEX){text_spec("Samples", background = "#38d199", color = "white", bold = T, font_size = 14)}`

<!-- devtools::install_github("walkerke/bsselectR"); devtools::install_github('walkerke/acs14lite') -->
  
```{r, out.width="100%", out.height="100%", echo = FALSE, , fig.cap='Uniform Manifold Approximation and Projection (UMAP) projection of transcriptionally and functionally distinct clusters, highlighted by cell type group. UMAP projection of cells colored by AUC scores. We split the cells into the cells that pass the assignment threshold (colored in shades of pink-red), and the cells that don’t (colored in black-blue). UMAP constructs a high-dimensional graph representation of the data, then builds a low-dimensional graph that is as structurally similar as possible.'}
library(stringr)
library(bsselectR)

state_plots =  list.files('Inputs_Interactive_Report/10X-gex', pattern = '_UMAP_Plot.png', recursive = T)

state_plots = paste0('Inputs_Interactive_Report/10X-gex/', state_plots)

names(state_plots) <- gsub('\\/.*','',str_replace_all(state_plots, c("_UMAP_Plot.png" = "", "Inputs_Interactive_Report/10X-gex/" = "")))

bsselect(state_plots, type = "img", selected = names(state_plots)[1], live_search = TRUE, show_tick = TRUE, frame_height = 700)
```

`r if(GEXgrouped){"#### UMAP GML"}`
`r if(GEXgrouped){text_spec("GML: Grouped Multiple Libraries per sample", background = "#38d199", color = "white", bold = T, font_size = 14)}`

```{r, eval=GEXgrouped, out.width="100%", out.height="100%", echo = FALSE, , fig.cap='Uniform Manifold Approximation and Projection (UMAP) projection of transcriptionally and functionally distinct clusters, highlighted by cell type group. UMAP projection of cells colored by AUC scores. We split the cells into the cells that pass the assignment threshold (colored in shades of pink-red), and the cells that don’t (colored in black-blue). UMAP constructs a high-dimensional graph representation of the data, then builds a low-dimensional graph that is as structurally similar as possible.'}

library(stringr)
library(bsselectR)

state_plots =  list.files('Inputs_Interactive_Report/10X-gex-grouped', pattern = '_UMAP_Plot.png', recursive = T)

state_plots = paste0('Inputs_Interactive_Report/10X-gex-grouped/', state_plots)

names(state_plots) <- gsub('\\/.*','',str_replace_all(state_plots, c("_UMAP_Plot.png" = "", "Inputs_Interactive_Report/10X-gex-grouped/" = "")))

bsselect(state_plots, type = "img", selected = names(state_plots)[1], live_search = TRUE, show_tick = TRUE, frame_height = 700)
```

`r if(GEX){"#### t-SNE Plot"}`
`r if(GEX){text_spec("Samples", background = "#38d199", color = "white", bold = T, font_size = 14)}`

```{r, out.width="100%", out.height="100%", echo = FALSE, , fig.cap='t-stochastic neighbor embedding (t-SNE) projection of transcriptionally and functionally distinct clusters, highlighted by cell type group. t-SNE projection of cells colored by AUC scores. We split the cells into the cells that pass the assignment threshold (colored in shades of pink-red), and the cells that don’t (colored in black-blue).'}
library(stringr)
library(bsselectR)

state_plots =  list.files('Inputs_Interactive_Report/10X-gex', pattern = '_tSNE_Plot.png', recursive = T)

state_plots = paste0('Inputs_Interactive_Report/10X-gex/', state_plots)

names(state_plots) <- gsub('\\/.*','',str_replace_all(state_plots, c("_tSNE_Plot.png" = "", "Inputs_Interactive_Report/10X-gex/" = "")))
 
bsselect(state_plots, type = "img", selected = names(state_plots)[1], live_search = TRUE, show_tick = TRUE, frame_height = 700)
```

`r if(GEXgrouped){"#### t-SNE GML"}`
`r if(GEXgrouped){text_spec("GML: Grouped Multiple Libraries per sample", background = "#38d199", color = "white", bold = T, font_size = 14)}`

```{r, eval=GEXgrouped, out.width="100%", out.height="100%", echo = FALSE, , fig.cap='t-stochastic neighbor embedding (t-SNE) projection of transcriptionally and functionally distinct clusters, highlighted by cell type group. t-SNE projection of cells colored by AUC scores. We split the cells into the cells that pass the assignment threshold (colored in shades of pink-red), and the cells that don’t (colored in black-blue).'}

library(stringr)
library(bsselectR)

state_plots =  list.files('Inputs_Interactive_Report/10X-gex-grouped', pattern = '_tSNE_Plot.png', recursive = T)

state_plots = paste0('Inputs_Interactive_Report/10X-gex-grouped/', state_plots)

names(state_plots) <- gsub('\\/.*','',str_replace_all(state_plots, c("_tSNE_Plot.png" = "", "Inputs_Interactive_Report/10X-gex-grouped/" = "")))

bsselect(state_plots, type = "img", selected = names(state_plots)[1], live_search = TRUE, show_tick = TRUE, frame_height = 700)
```

`r if(GEX){"#### Heatmap Plot"}`
`r if(GEX){text_spec("Samples", background = "#38d199", color = "white", bold = T, font_size = 14)}`

<!-- devtools::install_github("walkerke/bsselectR"); devtools::install_github('walkerke/acs14lite') -->

```{r, out.width="100%", out.height="100%", echo = FALSE, , fig.cap='Heatmap based on cells showing the most enriched expressed genes in each cell type group. '}
library(stringr)
library(bsselectR)

state_plots =  list.files('Inputs_Interactive_Report/10X-gex', pattern = '_HeatMap.png', recursive = T)

state_plots = paste0('Inputs_Interactive_Report/10X-gex/', state_plots)

names(state_plots) <- gsub('\\/.*','',str_replace_all(state_plots, c("_Celltype_assignment_HeatMap.png" = "", "Inputs_Interactive_Report/10X-gex/" = "")))
 
bsselect(state_plots, type = "img", selected = names(state_plots)[1], live_search = TRUE, show_tick = TRUE, frame_height = 900)
```

`r if(GEXgrouped){"#### Heatmap GML"}`
`r if(GEXgrouped){text_spec("GML: Grouped Multiple Libraries per sample", background = "#38d199", color = "white", bold = T, font_size = 14)}`

```{r, eval=GEXgrouped, out.width="100%", out.height="100%", echo = FALSE, , fig.cap='Heatmap based on cells showing the most enriched expressed genes in each cell type group.'}

library(stringr)
library(bsselectR)

state_plots =  list.files('Inputs_Interactive_Report/10X-gex-grouped', pattern = '_Celltype_assignment_HeatMap.png', recursive = T)

state_plots = paste0('Inputs_Interactive_Report/10X-gex-grouped/', state_plots)

names(state_plots) <- gsub('\\/.*','',str_replace_all(state_plots, c("_Celltype_assignment_HeatMap.png" = "", "Inputs_Interactive_Report/10X-gex-grouped/" = "")))

bsselect(state_plots, type = "img", selected = names(state_plots)[1], live_search = TRUE, show_tick = TRUE, frame_height = 900)
```

`r if(GEX){"#### Barcode Rank Plot(s)"}`
`r if(GEX){text_spec("Samples", background = "#38d199", color = "white", bold = T, font_size = 14)}`

```{r, eval=GEX, out.width="100%", out.height="100%", echo = FALSE, , fig.cap='The Barcode Rank Plot shows the distribution of non-duplicate reads with mapping quality at least 30 per barcode and which barcodes were inferred to be associated with cells. The y-axis shows the value that cellranger-dna uses to call cells and the x-axis is the number of barcodes below that value.'}

library(stringr)
library(bsselectR)

state_plots =  list.files('Inputs_Interactive_Report/10X-gex', pattern = '_Knee_Plot.png', recursive = T)

state_plots = paste0('Inputs_Interactive_Report/10X-gex/', state_plots)

names(state_plots) <- gsub('\\/.*','',str_replace_all(state_plots, c("_Knee_Plot.png" = "", "Inputs_Interactive_Report/10X-gex/" = "")))

bsselect(state_plots, type = "img", selected = names(state_plots)[1], live_search = TRUE, show_tick = TRUE, frame_height = 900)
```

`r if(GEXgrouped){"#### Barcode Rank Plot(s) GML"}`
`r if(GEXgrouped){text_spec("GML: Grouped Multiple Libraries per sample", background = "#38d199", color = "white", bold = T, font_size = 14)}`

```{r, eval=GEXgrouped, out.width="100%", out.height="100%", echo = FALSE, , fig.cap='The Barcode Rank Plot shows the distribution of non-duplicate reads with mapping quality at least 30 per barcode and which barcodes were inferred to be associated with cells. The y-axis shows the value that cellranger-dna uses to call cells and the x-axis is the number of barcodes below that value. The Barcode Rank Plot is equivalent to a transposed empirical cumulative density plot with log-transformed axes.'}

library(stringr)
library(bsselectR)

state_plots =  list.files('Inputs_Interactive_Report/10X-gex-grouped', pattern = '_Knee_Plot.png', recursive = T)

state_plots = paste0('Inputs_Interactive_Report/10X-gex-grouped/', state_plots)

names(state_plots) <- gsub('\\/.*','',str_replace_all(state_plots, c("_Knee_Plot.png" = "", "Inputs_Interactive_Report/10X-gex-grouped/" = "")))

bsselect(state_plots, type = "img", selected = names(state_plots)[1], live_search = TRUE, show_tick = TRUE, frame_height = 900)
```

<!-- ### `r kableExtra::text_spec("Link for Further Information", color = "blue")`  -->
<!-- The analysis, gene count matrix, and reports have been copied to the "additional_analyses" folder on the FTP server ([LINK](ftp://`r ProjectNameFTP_Path`:`r ProjectNameFTP_password`@ftp.well.ox.ac.uk/)). -->
